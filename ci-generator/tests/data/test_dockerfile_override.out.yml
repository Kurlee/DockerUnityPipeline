# !!! Do not edit this file manually, see ci-generator folder !!!
test-ci-generator:
  stage: test
  image: python:3.7-alpine
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  cache:
    paths:
      - .cache/pip
      - ci-generator/venv/
  before_script:
    - cd ci-generator
    - python -V
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - pip install -r requirements.txt
  script:
    - coverage run -m unittest tests/test*.py
    - coverage report
    - coverage html
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  artifacts:
    paths:
      - ci-generator/htmlcov

image: docker:latest

variables:
  IMAGE_LABELS: >
    --label vcs-url=$CI_PROJECT_URL
    --label com.gitlab.ci.builder=$GITLAB_USER_EMAIL
    --label com.gitlab.ci.pipeline=$CI_PROJECT_URL/pipelines/$CI_PIPELINE_ID
    --label com.gitlab.ci.ref=$CI_BUILD_REF_NAME
    --label com.gitlab.ci.build=$CI_PROJECT_URL/builds/$CI_BUILD_ID
    --label com.gableroux.unity3d.version=$VERSION
    --label com.gableroux.unity3d.build=$BUILD
    --label com.gableroux.unity3d.tag=$TAG
    --label com.gableroux.unity3d.download_url=$DOWNLOAD_URL
    --label com.gableroux.unity3d.sha1=$SHA1
    --label com.gableroux.unity3d.release_notes=$RELEASE_NOTES
    --label com.gableroux.unity3d.release_url=$RELEASE_URL
  IMAGE_ARGUMENTS: >
    --build-arg DOWNLOAD_URL=$DOWNLOAD_URL
    --build-arg COMPONENTS=$COMPONENTS
    --build-arg SHA1=$SHA1
    --build-arg BASE_IMAGE=$CI_REGISTRY_IMAGE:$VERSION$BUILD
  # https://about.gitlab.com/2019/07/31/docker-in-docker-with-docker-19-dot-03/
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
services:
  - docker:19.03.0-dind

stages:
  - test
  - prepare
  - build

before_script:
  - docker info
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY

.build: &build
  stage : build
  script:
    - if [ "$CI_COMMIT_REF_NAME" = "master" ]
      ; then
        export REGISTRY=$CI_REGISTRY_IMAGE:$TAG
      ; else
        export REGISTRY=$CI_REGISTRY_IMAGE:$TAG-$CI_COMMIT_REF_SLUG
      ; fi
    - docker build -f ./docker/${DOCKERFILE_NAME}.Dockerfile $IMAGE_LABELS --label build-date=`date -Iseconds` $IMAGE_ARGUMENTS --pull -t "$REGISTRY" ./docker/
    - docker push "$REGISTRY"
    - |
      if [ "$CI_COMMIT_REF_NAME" = "master" ] && [ -n "$LATEST" ]; then
        echo "Marking $REGISTRY as latest image"
        docker tag "$REGISTRY" "$CI_REGISTRY_IMAGE:latest"
        docker push "$CI_REGISTRY_IMAGE:latest"
      fi
  retry: 2

# prepare image 2019.1.3f1
prepare_2019_1_3f1:
  stage: prepare
  variables:
    VERSION: 2019.1.3
    BUILD: f1
    DOWNLOAD_URL: https://beta.unity3d.com/download/dc414eb9ed43/UnitySetup-2019.1.3f1
    SHA1: ea97ef4c42180bd833e5b31b56f083b727a99cc8
  script:
    - export REGISTRY=$CI_REGISTRY_IMAGE:$VERSION$BUILD
    - docker build -f ./docker/ubuntu_prepare.Dockerfile $IMAGE_LABELS --label build-date=`date -Iseconds` $IMAGE_ARGUMENTS --pull -t "$REGISTRY" ./docker/
    - docker push "$REGISTRY"
    - docker run "$REGISTRY" cat Unity_v$VERSION$BUILD.alf >> licence_request.alf
  artifacts:
    paths:
      - licence_request.alf

# platform specific for 2019.1.3f1: windows
unity_2019_1_3f1-windows:
  <<: *build
  variables:
    DOCKERFILE_NAME: custom_value_here
    VERSION: 2019.1.3
    BUILD: f1
    TAG: 2019.1.3f1-windows
    COMPONENTS: Windows,Windows-Mono
    DOWNLOAD_URL: https://beta.unity3d.com/download/dc414eb9ed43/UnitySetup-2019.1.3f1
    SHA1: ea97ef4c42180bd833e5b31b56f083b727a99cc8
    RELEASE_NOTES: https://unity3d.com/unity/whats-new/2019.1.3f1
    RELEASE_URL: https://beta.unity3d.com/download/dc414eb9ed43/public_download.html


# platform specific for 2019.1.3f1: mac
unity_2019_1_3f1-mac:
  <<: *build
  variables:
    DOCKERFILE_NAME: custom_value_here
    VERSION: 2019.1.3
    BUILD: f1
    TAG: 2019.1.3f1-mac
    COMPONENTS: Mac,Mac-Mono
    DOWNLOAD_URL: https://beta.unity3d.com/download/dc414eb9ed43/UnitySetup-2019.1.3f1
    SHA1: ea97ef4c42180bd833e5b31b56f083b727a99cc8
    RELEASE_NOTES: https://unity3d.com/unity/whats-new/2019.1.3f1
    RELEASE_URL: https://beta.unity3d.com/download/dc414eb9ed43/public_download.html


# platform specific for 2019.1.3f1: ios
unity_2019_1_3f1-ios:
  <<: *build
  variables:
    DOCKERFILE_NAME: custom_value_here
    VERSION: 2019.1.3
    BUILD: f1
    TAG: 2019.1.3f1-ios
    COMPONENTS: iOS
    DOWNLOAD_URL: https://beta.unity3d.com/download/dc414eb9ed43/UnitySetup-2019.1.3f1
    SHA1: ea97ef4c42180bd833e5b31b56f083b727a99cc8
    RELEASE_NOTES: https://unity3d.com/unity/whats-new/2019.1.3f1
    RELEASE_URL: https://beta.unity3d.com/download/dc414eb9ed43/public_download.html


# platform specific for 2019.1.3f1: android
unity_2019_1_3f1-android:
  <<: *build
  variables:
    DOCKERFILE_NAME: custom_value_here
    VERSION: 2019.1.3
    BUILD: f1
    TAG: 2019.1.3f1-android
    COMPONENTS: Android
    DOWNLOAD_URL: https://beta.unity3d.com/download/dc414eb9ed43/UnitySetup-2019.1.3f1
    SHA1: ea97ef4c42180bd833e5b31b56f083b727a99cc8
    RELEASE_NOTES: https://unity3d.com/unity/whats-new/2019.1.3f1
    RELEASE_URL: https://beta.unity3d.com/download/dc414eb9ed43/public_download.html


# platform specific for 2019.1.3f1: webgl
unity_2019_1_3f1-webgl:
  <<: *build
  variables:
    DOCKERFILE_NAME: custom_value_here
    VERSION: 2019.1.3
    BUILD: f1
    TAG: 2019.1.3f1-webgl
    COMPONENTS: WebGL
    DOWNLOAD_URL: https://beta.unity3d.com/download/dc414eb9ed43/UnitySetup-2019.1.3f1
    SHA1: ea97ef4c42180bd833e5b31b56f083b727a99cc8
    RELEASE_NOTES: https://unity3d.com/unity/whats-new/2019.1.3f1
    RELEASE_URL: https://beta.unity3d.com/download/dc414eb9ed43/public_download.html


# platform specific for 2019.1.3f1: facebook
unity_2019_1_3f1-facebook:
  <<: *build
  variables:
    DOCKERFILE_NAME: custom_value_here
    VERSION: 2019.1.3
    BUILD: f1
    TAG: 2019.1.3f1-facebook
    COMPONENTS: Facebook-Games
    DOWNLOAD_URL: https://beta.unity3d.com/download/dc414eb9ed43/UnitySetup-2019.1.3f1
    SHA1: ea97ef4c42180bd833e5b31b56f083b727a99cc8
    RELEASE_NOTES: https://unity3d.com/unity/whats-new/2019.1.3f1
    RELEASE_URL: https://beta.unity3d.com/download/dc414eb9ed43/public_download.html