# !!! Do not edit this file manually, see ci-generator folder !!!
test-ci-generator:
  stage: test
  image: python:3.7-alpine
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  cache:
    paths:
      - .cache/pip
      - ci-generator/venv/
  before_script:
    - cd ci-generator
    - python -V
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - pip install -r requirements.txt
  script:
    - coverage run -m unittest tests/test*.py
    - coverage report
    - coverage html
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  artifacts:
    paths:
      - ci-generator/htmlcov

variables:
  # https://about.gitlab.com/2019/07/31/docker-in-docker-with-docker-19-dot-03/
  # https://gitlab.com/gitlab-org/gitlab-runner/issues/4501
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_DRIVER: overlay2

image: docker:18.09

services:
  - docker:18.09-dind

stages:
  - test
  - prepare
  - build

before_script:
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY

.build: &build
  stage : build
  script:
    - ci/build.sh
  retry: 2

# prepare image 2017.2.1f1
prepare_2017_2_1f1:
  stage: prepare
  variables:
    VERSION: 2017.2.1
    BUILD: f1
    DOWNLOAD_URL: https://beta.unity3d.com/download/ce9f6a0436e1+/unity-editor_amd64-2017.2.1f1.deb
    SHA1: af4301f17ec256095d133091f6a37a3cc74ce7da
  script:
    - ci/prepare.sh
  artifacts:
    paths:
      - licence_request.alf
  retry: 2